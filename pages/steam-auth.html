<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conectando Steam - Kyubii</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1d064d 0%, #4800bd 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .container {
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 30px;
        }

        .status {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>üîó Conectando Steam...</h1>
        <p>Por favor, autentique-se no Steam</p>
        <p id="contador"></p>
        <div class="status">
            Voc√™ ser√° redirecionado automaticamente ap√≥s a autentica√ß√£o
        </div>
    </div>

    <script>
        // ‚úÖ 1. FUN√á√ÉO PARA REDIRECIONAR PARA STEAM
        function iniciarAutenticacaoSteam() {
            console.log('üîó Iniciando autentica√ß√£o Steam...');

            // Redireciona para /steam-login do app.py
            // O app.py vai redirecionar para Steam
            // Ap√≥s autentica√ß√£o, Steam redireciona para /steam-callback
            // /steam-callback retorna HTML que salva dados e redireciona

            window.location.href = '/steam-login';
        }

        // ‚úÖ 2. AGUARDAR DADOS DO STEAM NO LOCALSTORAGE
        let tentativas = 0;
        const maxTentativas = 120; // 2 minutos (120 * 1s)

        const intervalo = setInterval(() => {
            tentativas++;

            // Atualizar contador
            const contador = document.getElementById('contador');
            if (contador) {
                contador.textContent = `Tentativa ${tentativas}...`;
            }

            console.log(`‚è±Ô∏è Aguardando dados do Steam... (${tentativas}s)`);

            // Verificar se dados foram salvos
            const steamId = localStorage.getItem('steamId');
            const steamUsername = localStorage.getItem('steamUsername');

            if (steamId && steamId !== 'null') {
                console.log('‚úÖ Dados do Steam recebidos!');
                console.log('   steamId:', steamId);
                console.log('   usuario:', steamUsername);

                clearInterval(intervalo);

                // ‚úÖ Chamar SteamSync para sincronizar
                if (typeof SteamSync !== 'undefined') {
                    console.log('üîÑ Sincronizando com SteamSync...');
                    SteamSync.sincronizar();
                }

                // Redirecionar para perfil
                setTimeout(() => {
                    console.log('üìç Redirecionando para perfil...');
                    window.location.href = '/pages/perfil.html';
                }, 1000);

                return;
            }

            // Se passou do tempo m√°ximo
            if (tentativas > maxTentativas) {
                clearInterval(intervalo);
                console.error('‚ùå Timeout: autentica√ß√£o Steam demorou muito');
                alert('Timeout na autentica√ß√£o Steam. Tente novamente.');
                window.close();
            }
        }, 1000);

        // ‚úÖ 3. INICIAR O FLUXO
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ steam-auth.html carregado');
            console.log('üöÄ Iniciando autentica√ß√£o Steam...');

            // Pequeno delay para garantir que localStorage est√° pronto
            setTimeout(() => {
                iniciarAutenticacaoSteam();
            }, 500);
        });

        // ‚úÖ 4. TRATAMENTO DE VISIBILIDADE (em caso de popup ser minimizado)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('üëÅÔ∏è Janela ficou vis√≠vel novamente');
                // Verificar novamente se dados foram salvos
            }
        });
    </script>
</body>
</html>
